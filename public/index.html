<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AI Team Orchestrator</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
      background: #0f172a;
      color: #e2e8f0;
      min-height: 100vh;
    }

    .header {
      background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
      padding: 1.5rem 2rem;
      border-bottom: 1px solid #334155;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .header h1 {
      font-size: 1.5rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .header h1 span {
      font-size: 1.75rem;
    }

    .stats {
      display: flex;
      gap: 2rem;
    }

    .stat {
      text-align: center;
    }

    .stat-value {
      font-size: 1.5rem;
      font-weight: 700;
      color: #22d3ee;
    }

    .stat-label {
      font-size: 0.75rem;
      color: #94a3b8;
      text-transform: uppercase;
    }

    .main {
      display: flex;
      height: calc(100vh - 80px);
    }

    .sidebar {
      width: 280px;
      background: #1e293b;
      border-right: 1px solid #334155;
      padding: 1.5rem;
      overflow-y: auto;
    }

    .sidebar h2 {
      font-size: 0.875rem;
      color: #94a3b8;
      text-transform: uppercase;
      margin-bottom: 1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .agent-list {
      list-style: none;
    }

    .agent-item {
      padding: 0.75rem;
      border-radius: 0.5rem;
      margin-bottom: 0.5rem;
      cursor: pointer;
      transition: background 0.2s;
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .agent-item:hover {
      background: #334155;
    }

    .agent-avatar {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.25rem;
    }

    .agent-avatar.manager { background: #7c3aed; }
    .agent-avatar.specialist { background: #2563eb; }
    .agent-avatar.support { background: #059669; }

    .agent-info h3 {
      font-size: 0.875rem;
      font-weight: 500;
    }

    .agent-info p {
      font-size: 0.75rem;
      color: #94a3b8;
    }

    .kanban {
      flex: 1;
      display: flex;
      gap: 1.5rem;
      padding: 1.5rem;
      overflow-x: auto;
    }

    .column {
      min-width: 300px;
      max-width: 320px;
      background: #1e293b;
      border-radius: 0.75rem;
      display: flex;
      flex-direction: column;
    }

    .column-header {
      padding: 1rem;
      border-bottom: 1px solid #334155;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .column-header h3 {
      font-size: 0.875rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .column-count {
      background: #334155;
      padding: 0.25rem 0.5rem;
      border-radius: 9999px;
      font-size: 0.75rem;
    }

    .column-header .dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
    }

    .dot.backlog { background: #64748b; }
    .dot.ready { background: #22d3ee; }
    .dot.in_progress { background: #f59e0b; }
    .dot.done { background: #22c55e; }

    .column-body {
      flex: 1;
      padding: 1rem;
      overflow-y: auto;
    }

    .task-card {
      background: #0f172a;
      border: 1px solid #334155;
      border-radius: 0.5rem;
      padding: 1rem;
      margin-bottom: 0.75rem;
      cursor: grab;
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .task-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }

    .task-card.dragging {
      opacity: 0.5;
    }

    .task-priority {
      display: inline-block;
      padding: 0.125rem 0.5rem;
      border-radius: 9999px;
      font-size: 0.625rem;
      font-weight: 600;
      margin-bottom: 0.5rem;
    }

    .priority-P0 { background: #dc2626; color: white; }
    .priority-P1 { background: #f59e0b; color: black; }
    .priority-P2 { background: #3b82f6; color: white; }

    .task-title {
      font-size: 0.875rem;
      font-weight: 500;
      margin-bottom: 0.5rem;
      line-height: 1.4;
    }

    .task-description {
      font-size: 0.75rem;
      color: #94a3b8;
      margin-bottom: 0.75rem;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    .task-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .task-owner {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.75rem;
      color: #94a3b8;
    }

    .owner-avatar {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: #3b82f6;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.625rem;
    }

    .task-actions {
      display: flex;
      gap: 0.5rem;
    }

    .task-action-btn {
      background: none;
      border: none;
      color: #64748b;
      cursor: pointer;
      padding: 0.25rem;
      border-radius: 0.25rem;
      transition: color 0.2s, background 0.2s;
    }

    .task-action-btn:hover {
      color: #e2e8f0;
      background: #334155;
    }

    .add-task-btn {
      width: 100%;
      padding: 0.75rem;
      background: transparent;
      border: 2px dashed #334155;
      border-radius: 0.5rem;
      color: #64748b;
      cursor: pointer;
      font-size: 0.875rem;
      transition: border-color 0.2s, color 0.2s;
    }

    .add-task-btn:hover {
      border-color: #22d3ee;
      color: #22d3ee;
    }

    /* Modal */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      z-index: 100;
      align-items: center;
      justify-content: center;
    }

    .modal-overlay.active {
      display: flex;
    }

    .modal {
      background: #1e293b;
      border-radius: 0.75rem;
      padding: 1.5rem;
      width: 100%;
      max-width: 500px;
      border: 1px solid #334155;
    }

    .modal h2 {
      margin-bottom: 1.5rem;
    }

    .form-group {
      margin-bottom: 1rem;
    }

    .form-group label {
      display: block;
      font-size: 0.875rem;
      color: #94a3b8;
      margin-bottom: 0.5rem;
    }

    .form-group input,
    .form-group textarea,
    .form-group select {
      width: 100%;
      padding: 0.75rem;
      background: #0f172a;
      border: 1px solid #334155;
      border-radius: 0.5rem;
      color: #e2e8f0;
      font-size: 0.875rem;
    }

    .form-group textarea {
      min-height: 100px;
      resize: vertical;
    }

    .modal-actions {
      display: flex;
      justify-content: flex-end;
      gap: 1rem;
      margin-top: 1.5rem;
    }

    .btn {
      padding: 0.75rem 1.5rem;
      border-radius: 0.5rem;
      font-size: 0.875rem;
      font-weight: 500;
      cursor: pointer;
      transition: background 0.2s;
    }

    .btn-secondary {
      background: #334155;
      border: none;
      color: #e2e8f0;
    }

    .btn-secondary:hover {
      background: #475569;
    }

    .btn-primary {
      background: #22d3ee;
      border: none;
      color: #0f172a;
    }

    .btn-primary:hover {
      background: #06b6d4;
    }

    /* Run Agent Panel */
    .run-agent-panel {
      background: #1e293b;
      border-radius: 0.75rem;
      padding: 1rem;
      margin-top: 1.5rem;
    }

    .run-agent-panel h3 {
      font-size: 0.875rem;
      margin-bottom: 1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .run-agent-form {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }

    .run-agent-form select,
    .run-agent-form input {
      padding: 0.5rem;
      background: #0f172a;
      border: 1px solid #334155;
      border-radius: 0.375rem;
      color: #e2e8f0;
      font-size: 0.875rem;
    }

    .run-agent-form button {
      padding: 0.5rem 1rem;
      background: #7c3aed;
      border: none;
      border-radius: 0.375rem;
      color: white;
      font-size: 0.875rem;
      cursor: pointer;
    }

    .run-agent-form button:hover {
      background: #6d28d9;
    }

    .loading {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 2rem;
      color: #94a3b8;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .spinner {
      width: 24px;
      height: 24px;
      border: 2px solid #334155;
      border-top-color: #22d3ee;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-right: 0.75rem;
    }
  </style>
</head>
<body>
  <header class="header">
    <h1><span>ü§ñ</span> AI Team Orchestrator</h1>
    <div class="stats">
      <div class="stat">
        <div class="stat-value" id="total-tasks">0</div>
        <div class="stat-label">Total Tasks</div>
      </div>
      <div class="stat">
        <div class="stat-value" id="in-progress-tasks">0</div>
        <div class="stat-label">In Progress</div>
      </div>
      <div class="stat">
        <div class="stat-value" id="done-tasks">0</div>
        <div class="stat-label">Completed</div>
      </div>
    </div>
  </header>

  <main class="main">
    <aside class="sidebar">
      <h2>üë• Agents</h2>
      <ul class="agent-list" id="agent-list">
        <li class="loading"><div class="spinner"></div> Loading agents...</li>
      </ul>

      <div class="run-agent-panel">
        <h3>‚ö° Run Agent</h3>
        <form class="run-agent-form" id="run-agent-form">
          <select id="agent-select" required>
            <option value="">Select an agent...</option>
          </select>
          <input type="text" id="task-input" placeholder="Enter task description..." required>
          <button type="submit">Run Task</button>
        </form>
      </div>
    </aside>

    <div class="kanban" id="kanban">
      <div class="column" data-status="backlog">
        <div class="column-header">
          <h3><span class="dot backlog"></span> Backlog</h3>
          <span class="column-count" id="count-backlog">0</span>
        </div>
        <div class="column-body" id="tasks-backlog"></div>
        <div style="padding: 1rem;">
          <button class="add-task-btn" onclick="openAddTaskModal('backlog')">+ Add Task</button>
        </div>
      </div>

      <div class="column" data-status="ready">
        <div class="column-header">
          <h3><span class="dot ready"></span> Ready</h3>
          <span class="column-count" id="count-ready">0</span>
        </div>
        <div class="column-body" id="tasks-ready"></div>
      </div>

      <div class="column" data-status="in_progress">
        <div class="column-header">
          <h3><span class="dot in_progress"></span> In Progress</h3>
          <span class="column-count" id="count-in_progress">0</span>
        </div>
        <div class="column-body" id="tasks-in_progress"></div>
      </div>

      <div class="column" data-status="done">
        <div class="column-header">
          <h3><span class="dot done"></span> Done</h3>
          <span class="column-count" id="count-done">0</span>
        </div>
        <div class="column-body" id="tasks-done"></div>
      </div>
    </div>
  </main>

  <!-- Add Task Modal -->
  <div class="modal-overlay" id="add-task-modal">
    <div class="modal">
      <h2>Create New Task</h2>
      <form id="add-task-form">
        <div class="form-group">
          <label>Title</label>
          <input type="text" id="new-task-title" required>
        </div>
        <div class="form-group">
          <label>Description</label>
          <textarea id="new-task-description"></textarea>
        </div>
        <div class="form-group">
          <label>Owner</label>
          <select id="new-task-owner">
            <option value="">Unassigned</option>
          </select>
        </div>
        <div class="form-group">
          <label>Priority</label>
          <select id="new-task-priority">
            <option value="">None</option>
            <option value="P0">P0 - Critical</option>
            <option value="P1">P1 - High</option>
            <option value="P2">P2 - Medium</option>
          </select>
        </div>
        <input type="hidden" id="new-task-status" value="backlog">
        <div class="modal-actions">
          <button type="button" class="btn btn-secondary" onclick="closeAddTaskModal()">Cancel</button>
          <button type="submit" class="btn btn-primary">Create Task</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    const API_BASE = '';
    const PROJECT_ID = 'default';
    let agents = [];
    let tasks = [];

    // Fetch agents
    async function fetchAgents() {
      try {
        const response = await fetch(`${API_BASE}/api/agents`);
        agents = await response.json();
        renderAgents();
        populateAgentSelects();
      } catch (error) {
        console.error('Failed to fetch agents:', error);
        document.getElementById('agent-list').innerHTML = '<li style="color: #f87171;">Failed to load agents</li>';
      }
    }

    // Render agents in sidebar
    function renderAgents() {
      const agentList = document.getElementById('agent-list');
      if (agents.length === 0) {
        agentList.innerHTML = '<li style="color: #94a3b8;">No agents configured</li>';
        return;
      }

      agentList.innerHTML = agents.map(agent => `
        <li class="agent-item" onclick="selectAgent('${agent.name}')">
          <div class="agent-avatar ${agent.role}">${getAgentEmoji(agent.role)}</div>
          <div class="agent-info">
            <h3>${agent.name}</h3>
            <p>${agent.role}</p>
          </div>
        </li>
      `).join('');
    }

    function getAgentEmoji(role) {
      const emojis = { manager: 'üëî', specialist: 'üîß', support: 'üõ†Ô∏è' };
      return emojis[role] || 'ü§ñ';
    }

    // Populate agent selects
    function populateAgentSelects() {
      const selects = [document.getElementById('agent-select'), document.getElementById('new-task-owner')];
      selects.forEach(select => {
        if (!select) return;
        const currentValue = select.value;
        const options = select.id === 'agent-select'
          ? '<option value="">Select an agent...</option>'
          : '<option value="">Unassigned</option>';
        select.innerHTML = options + agents.map(a =>
          `<option value="${a.name}">${a.name} (${a.role})</option>`
        ).join('');
        select.value = currentValue;
      });
    }

    // Fetch tasks
    async function fetchTasks() {
      try {
        const response = await fetch(`${API_BASE}/api/projects/${PROJECT_ID}/tasks`);
        tasks = await response.json();
        renderTasks();
        updateStats();
      } catch (error) {
        console.error('Failed to fetch tasks:', error);
      }
    }

    // Render tasks in Kanban columns
    function renderTasks() {
      const statuses = ['backlog', 'ready', 'in_progress', 'done'];
      statuses.forEach(status => {
        const container = document.getElementById(`tasks-${status}`);
        const statusTasks = tasks.filter(t => t.status === status);
        document.getElementById(`count-${status}`).textContent = statusTasks.length;

        container.innerHTML = statusTasks.map(task => `
          <div class="task-card" draggable="true" data-task-id="${task.id}"
               ondragstart="dragStart(event)" ondragend="dragEnd(event)">
            ${task.priority ? `<span class="task-priority priority-${task.priority}">${task.priority}</span>` : ''}
            <div class="task-title">${escapeHtml(task.title)}</div>
            ${task.description ? `<div class="task-description">${escapeHtml(task.description)}</div>` : ''}
            <div class="task-footer">
              <div class="task-owner">
                ${task.owner ? `<div class="owner-avatar">${task.owner.charAt(0).toUpperCase()}</div>${task.owner}` : 'Unassigned'}
              </div>
              <div class="task-actions">
                <button class="task-action-btn" onclick="deleteTask('${task.id}')" title="Delete">üóëÔ∏è</button>
              </div>
            </div>
          </div>
        `).join('');
      });

      // Set up drop zones
      document.querySelectorAll('.column-body').forEach(col => {
        col.ondragover = dragOver;
        col.ondrop = drop;
      });
    }

    // Update stats
    function updateStats() {
      document.getElementById('total-tasks').textContent = tasks.length;
      document.getElementById('in-progress-tasks').textContent = tasks.filter(t => t.status === 'in_progress').length;
      document.getElementById('done-tasks').textContent = tasks.filter(t => t.status === 'done').length;
    }

    // Drag and drop
    let draggedTaskId = null;

    function dragStart(e) {
      draggedTaskId = e.target.dataset.taskId;
      e.target.classList.add('dragging');
    }

    function dragEnd(e) {
      e.target.classList.remove('dragging');
    }

    function dragOver(e) {
      e.preventDefault();
    }

    async function drop(e) {
      e.preventDefault();
      const newStatus = e.currentTarget.id.replace('tasks-', '');
      if (draggedTaskId && newStatus) {
        await updateTaskStatus(draggedTaskId, newStatus);
      }
    }

    async function updateTaskStatus(taskId, status) {
      try {
        await fetch(`${API_BASE}/api/tasks/${taskId}`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ status })
        });
        await fetchTasks();
      } catch (error) {
        console.error('Failed to update task:', error);
      }
    }

    async function deleteTask(taskId) {
      if (!confirm('Delete this task?')) return;
      try {
        await fetch(`${API_BASE}/api/tasks/${taskId}`, { method: 'DELETE' });
        await fetchTasks();
      } catch (error) {
        console.error('Failed to delete task:', error);
      }
    }

    // Add task modal
    function openAddTaskModal(status = 'backlog') {
      document.getElementById('new-task-status').value = status;
      document.getElementById('add-task-modal').classList.add('active');
    }

    function closeAddTaskModal() {
      document.getElementById('add-task-modal').classList.remove('active');
      document.getElementById('add-task-form').reset();
    }

    document.getElementById('add-task-form').onsubmit = async (e) => {
      e.preventDefault();
      const task = {
        title: document.getElementById('new-task-title').value,
        description: document.getElementById('new-task-description').value,
        owner: document.getElementById('new-task-owner').value || undefined,
        priority: document.getElementById('new-task-priority').value || undefined,
      };

      try {
        await fetch(`${API_BASE}/api/projects/${PROJECT_ID}/tasks`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(task)
        });
        closeAddTaskModal();
        await fetchTasks();
      } catch (error) {
        console.error('Failed to create task:', error);
      }
    };

    // Run agent
    function selectAgent(agentName) {
      document.getElementById('agent-select').value = agentName;
    }

    document.getElementById('run-agent-form').onsubmit = async (e) => {
      e.preventDefault();
      const agentName = document.getElementById('agent-select').value;
      const task = document.getElementById('task-input').value;

      if (!agentName || !task) return;

      const btn = e.target.querySelector('button');
      btn.textContent = 'Running...';
      btn.disabled = true;

      try {
        const response = await fetch(`${API_BASE}/api/run-agent`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ agentName, task })
        });
        const result = await response.json();
        alert('Agent completed!\n\n' + (result.result || '').substring(0, 500));
        await fetchTasks();
      } catch (error) {
        console.error('Failed to run agent:', error);
        alert('Failed to run agent');
      } finally {
        btn.textContent = 'Run Task';
        btn.disabled = false;
        document.getElementById('task-input').value = '';
      }
    };

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Initialize
    fetchAgents();
    fetchTasks();
    setInterval(fetchTasks, 30000); // Refresh every 30s
  </script>
</body>
</html>
